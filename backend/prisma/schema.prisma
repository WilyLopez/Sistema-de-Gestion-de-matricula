generator client {
    provider = "prisma-client-js"
}

datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

// Usuarios del sistema
model Usuario {
    id            String     @id @default(uuid())
    correo        String     @unique
    contrasena    String
    nombres       String
    apellidos     String
    rol           RolUsuario @default(SECRETARIA)
    estaActivo    Boolean    @default(true) @map("esta_activo")
    creadoEn      DateTime   @default(now()) @map("creado_en")
    actualizadoEn DateTime   @updatedAt @map("actualizado_en")

    matriculasCreadas Matricula[] @relation("MatriculaCreadaPor")

    @@map("usuarios")
}

enum RolUsuario {
    ADMIN
    DIRECTOR
    SECRETARIA
}

// Años académicos
model AnioAcademico {
    id            String   @id @default(uuid())
    anio          Int      @unique
    fechaInicio   DateTime @map("fecha_inicio")
    fechaFin      DateTime @map("fecha_fin")
    esActual      Boolean  @default(false) @map("es_actual")
    estaActivo    Boolean  @default(true) @map("esta_activo")
    creadoEn      DateTime @default(now()) @map("creado_en")
    actualizadoEn DateTime @updatedAt @map("actualizado_en")

    grados     Grado[]
    matriculas Matricula[]

    @@map("anios_academicos")
}

// Niveles educativos
enum NivelEducativo {
    PRIMARIA
    SECUNDARIA
}

// Grados
model Grado {
    id              String         @id @default(uuid())
    anioAcademicoId String         @map("anio_academico_id")
    nivel           NivelEducativo
    numeroGrado     Int            @map("numero_grado") // 1, 2, 3, 4, 5, 6
    costoMatricula  Decimal        @map("costo_matricula") @db.Decimal(10, 2)
    costoMensual    Decimal        @map("costo_mensual") @db.Decimal(10, 2)
    estaActivo      Boolean        @default(true) @map("esta_activo")
    creadoEn        DateTime       @default(now()) @map("creado_en")
    actualizadoEn   DateTime       @updatedAt @map("actualizado_en")

    anioAcademico AnioAcademico @relation(fields: [anioAcademicoId], references: [id], onDelete: Cascade)
    secciones     Seccion[]

    @@unique([anioAcademicoId, nivel, numeroGrado])
    @@map("grados")
}

// Secciones
model Seccion {
    id              String   @id @default(uuid())
    gradoId         String   @map("grado_id")
    nombre          String // A, B, C, etc.
    capacidadMaxima Int      @map("capacidad_maxima")
    capacidadActual Int      @default(0) @map("capacidad_actual")
    estaActivo      Boolean  @default(true) @map("esta_activo")
    creadoEn        DateTime @default(now()) @map("creado_en")
    actualizadoEn   DateTime @updatedAt @map("actualizado_en")

    grado      Grado       @relation(fields: [gradoId], references: [id], onDelete: Cascade)
    matriculas Matricula[]

    @@unique([gradoId, nombre])
    @@map("secciones")
}

// Apoderados
model Apoderado {
    id            String   @id @default(uuid())
    nombres       String
    apellidos     String
    dni           String   @unique
    parentesco    String // Padre, Madre, Tutor, etc.
    telefono      String
    correo        String?
    direccion     String
    ocupacion     String?
    creadoEn      DateTime @default(now()) @map("creado_en")
    actualizadoEn DateTime @updatedAt @map("actualizado_en")

    estudiantes Estudiante[]

    @@map("apoderados")
}

// Estudiantes
model Estudiante {
    id              String   @id @default(uuid())
    nombres         String
    apellidos       String
    dni             String   @unique
    fechaNacimiento DateTime @map("fecha_nacimiento")
    genero          Genero
    direccion       String
    telefono        String?
    apoderadoId     String   @map("apoderado_id")
    urlFoto         String?  @map("url_foto")
    estaActivo      Boolean  @default(true) @map("esta_activo")
    creadoEn        DateTime @default(now()) @map("creado_en")
    actualizadoEn   DateTime @updatedAt @map("actualizado_en")

    apoderado  Apoderado   @relation(fields: [apoderadoId], references: [id])
    matriculas Matricula[]
    documentos Documento[]

    @@map("estudiantes")
}

enum Genero {
    M
    F
}

// Matrículas
model Matricula {
    id              String          @id @default(uuid())
    codigo          String          @unique // Código de matrícula: MAT-2024-0001
    estudianteId    String          @map("estudiante_id")
    anioAcademicoId String          @map("anio_academico_id")
    seccionId       String          @map("seccion_id")
    tipoMatricula   TipoMatricula   @map("tipo_matricula")
    estado          EstadoMatricula @default(PENDIENTE)
    fechaMatricula  DateTime        @default(now()) @map("fecha_matricula")
    costoTotal      Decimal         @map("costo_total") @db.Decimal(10, 2)
    estaPagado      Boolean         @default(false) @map("esta_pagado")
    fechaPago       DateTime?       @map("fecha_pago")
    creadoPorId     String          @map("creado_por_id")
    observaciones   String?
    creadoEn        DateTime        @default(now()) @map("creado_en")
    actualizadoEn   DateTime        @updatedAt @map("actualizado_en")

    estudiante    Estudiante    @relation(fields: [estudianteId], references: [id])
    anioAcademico AnioAcademico @relation(fields: [anioAcademicoId], references: [id])
    seccion       Seccion       @relation(fields: [seccionId], references: [id])
    creadoPor     Usuario       @relation("MatriculaCreadaPor", fields: [creadoPorId], references: [id])

    @@unique([estudianteId, anioAcademicoId])
    @@map("matriculas")
}

enum TipoMatricula {
    NUEVA
    RENOVACION
}

enum EstadoMatricula {
    PENDIENTE
    CONFIRMADA
    CANCELADA
}

// Documentos
model Documento {
    id             String        @id @default(uuid())
    estudianteId   String        @map("estudiante_id")
    tipo           TipoDocumento
    nombreArchivo  String        @map("nombre_archivo")
    urlArchivo     String        @map("url_archivo")
    fechaSubida    DateTime      @default(now()) @map("fecha_subida")
    estaVerificado Boolean       @default(false) @map("esta_verificado")
    creadoEn       DateTime      @default(now()) @map("creado_en")
    actualizadoEn  DateTime      @updatedAt @map("actualizado_en")

    estudiante Estudiante @relation(fields: [estudianteId], references: [id], onDelete: Cascade)

    @@map("documentos")
}

enum TipoDocumento {
    PARTIDA_NACIMIENTO
    COPIA_DNI
    CERTIFICADO_ANTERIOR
    CERTIFICADO_SALUD
    FOTOS
    OTRO
}
